@page "/ViewModules"
@page "/ViewModules/{Id:int}"

@inject NavigationManager NavigationManager
@inject LoginClient LoginClient
@inject StudentManagement StudentManagement
@inject CourseManagement CourseManagement

<div class="mb-10">
    <PageTitle>View Modules</PageTitle>
    <h2>View @heading</h2>
</div>

@if (modules is null)
{
    <p>Loading...</p>
}
else if (LoginClient.GetLoggedInDetails().Username.Equals(string.Empty) || (LoginClient.GetLoggedInDetails().Role!.Equals("admin") && Id is null) || 
(LoginClient.GetLoggedInDetails().Role!.Equals("user") && Id is not null))
{
    <p>Page inaccessible</p>
}
else
{
    <table class="table table-striped table-bordered table-hover mt-3">
        <!--Bootstrap CSS styling added, mt adds margin from upper element-->
        <thead class="table-dark"> <!--Head of the table-->
        <th>No.</th>
        <th>Course</th>
        <th class="text-end">Module</th>
        <th class="text-end">Semester</th>
        <th></th>
        </thead>
        <tbody>
            @for(int x=1; x<modules.Count() + 1; x++)
            {
                <tr>
                    <td>@x</td>
                    <td>@modules[x - 1].Course</td>
                    <td class="text-end">@modules[x - 1].Module</td>
                    <td class="text-end">@modules[x - 1].Semester</td>
                    <td>
                        <div class="d-flex">
                            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="@GetModalId(modules[x - 1])" title="Remove Module">
                                <!--data-bs-target shows the modal (dialogue box)-->
                                <i class="bi bi-x-square"></i>
                            </button>
                        </div>
                        <DeleteModule courseDetails="@modules[x - 1]" />
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    [Parameter]
    public int? Id {get; set;}
    private CourseDetails[]? modules;
    string heading = string.Empty;

    protected async override Task OnInitializedAsync() // When client initialised then array is populated
    {
        if (Id is null)
        {
            modules = await CourseManagement.ViewStudentModulesAsync(LoginClient.GetLoggedInDetails().Name!);
            heading = $"{LoginClient.GetLoggedInDetails().Name}'s Modules";
        }
        else if (Id is not null)
        {
            Console.WriteLine(Id.Value);
            StudentDetails student = await StudentManagement.GetStudentAsync(Id.Value); // .Value lets you get value even when it is null
            Console.WriteLine(student.Name);
            modules = await CourseManagement.ViewStudentModulesAsync(student.Name);
            heading = $"{student.Name}'s Modules";
        }
    }
    private string GetModalId(CourseDetails module) // Gets the HTML ID of modal for corresponding student
    {
        return $"#{DeleteModule.MakeModalID(module)}";
    }
}